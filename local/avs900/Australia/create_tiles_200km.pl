#!/usr/bin/env perl
# create_tiles.pl
# Created on 14 Jul, 2019
# Last edit: 14 Jul, 2019
# By Dr. Arapaut V. Sivaprasad
# --------------------------------------
# To create DEA tiles as PNG images for the entire continent
my $j = 0;
$bboxes3857[$j++] = "12523442.71424328,-4383204.94998515,13149614.84995544,-3757032.81427298";
$bboxes3857[$j++] = "12523442.71424328,-3757032.81427298,13149614.84995544,-3130860.67856082";
$bboxes3857[$j++] = "12523442.71424328,-3130860.67856082,13149614.84995544,-2504688.54284865";
$bboxes3857[$j++] = "12523442.71424328,-2504688.54284865,13149614.84995544,-1878516.40713649";
$bboxes3857[$j++] = "13149614.84995544,-4383204.94998515,13775786.98566760,-3757032.81427298";
$bboxes3857[$j++] = "13149614.84995544,-3757032.81427298,13775786.98566760,-3130860.67856082";
$bboxes3857[$j++] = "13149614.84995544,-3130860.67856082,13775786.98566760,-2504688.54284865";
$bboxes3857[$j++] = "13149614.84995544,-2504688.54284865,13775786.98566760,-1878516.40713649";
$bboxes3857[$j++] = "13149614.84995544,-1878516.40713649,13775786.98566760,-1252344.27142433";
$bboxes3857[$j++] = "13775786.98566760,-4383204.94998515,14401959.12137977,-3757032.81427298";
$bboxes3857[$j++] = "13775786.98566760,-3757032.81427298,14401959.12137977,-3130860.67856082";
$bboxes3857[$j++] = "13775786.98566760,-3130860.67856082,14401959.12137977,-2504688.54284865";
$bboxes3857[$j++] = "13775786.98566760,-2504688.54284865,14401959.12137977,-1878516.40713649";
$bboxes3857[$j++] = "13775786.98566760,-1878516.40713649,14401959.12137977,-1252344.27142433";
$bboxes3857[$j++] = "14401959.12137977,-4383204.94998515,15028131.25709194,-3757032.81427298";
$bboxes3857[$j++] = "14401959.12137977,-3757032.81427298,15028131.25709194,-3130860.67856082";
$bboxes3857[$j++] = "14401959.12137977,-3130860.67856082,15028131.25709194,-2504688.54284865";
$bboxes3857[$j++] = "14401959.12137977,-2504688.54284865,15028131.25709194,-1878516.40713649";
$bboxes3857[$j++] = "14401959.12137977,-1878516.40713649,15028131.25709194,-1252344.27142433";
$bboxes3857[$j++] = "15028131.25709194,-5009377.08569731,15654303.39280410,-4383204.94998515";
$bboxes3857[$j++] = "15028131.25709194,-4383204.94998515,15654303.39280410,-3757032.81427298";
$bboxes3857[$j++] = "15028131.25709194,-3757032.81427298,15654303.39280410,-3130860.67856082";
$bboxes3857[$j++] = "15028131.25709194,-3130860.67856082,15654303.39280410,-2504688.54284865";
$bboxes3857[$j++] = "15028131.25709194,-2504688.54284865,15654303.39280410,-1878516.40713649";
$bboxes3857[$j++] = "15028131.25709194,-1878516.40713649,15654303.39280410,-1252344.27142433";
$bboxes3857[$j++] = "15654303.39280410,-5635549.22140947,16280475.52851626,-5009377.08569731";
$bboxes3857[$j++] = "15654303.39280410,-5009377.08569731,16280475.52851626,-4383204.94998515";
$bboxes3857[$j++] = "15654303.39280410,-4383204.94998515,16280475.52851626,-3757032.81427298";
$bboxes3857[$j++] = "15654303.39280410,-3757032.81427298,16280475.52851626,-3130860.67856082";
$bboxes3857[$j++] = "15654303.39280410,-3130860.67856082,16280475.52851626,-2504688.54284865";
$bboxes3857[$j++] = "15654303.39280410,-2504688.54284865,16280475.52851626,-1878516.40713649";
$bboxes3857[$j++] = "15654303.39280410,-1878516.40713649,16280475.52851626,-1252344.27142433";
$bboxes3857[$j++] = "16280475.52851626,-5635549.22140947,16906647.66422843,-5009377.08569731";
$bboxes3857[$j++] = "16280475.52851626,-5009377.08569731,16906647.66422843,-4383204.94998515";
$bboxes3857[$j++] = "16280475.52851626,-4383204.94998515,16906647.66422843,-3757032.81427298";
$bboxes3857[$j++] = "16280475.52851626,-3757032.81427298,16906647.66422843,-3130860.67856082";
$bboxes3857[$j++] = "16280475.52851626,-3130860.67856082,16906647.66422843,-2504688.54284865";
$bboxes3857[$j++] = "16280475.52851626,-2504688.54284865,16906647.66422843,-1878516.40713649";
$bboxes3857[$j++] = "16906647.66422843,-4383204.94998515,17532819.79994059,-3757032.81427298";
$bboxes3857[$j++] = "16906647.66422843,-3757032.81427298,17532819.79994059,-3130860.67856082";
$bboxes3857[$j] = "16906647.66422843,-3130860.67856082,17532819.79994059,-2504688.54284865";
$n_tiles = $j;

`curl 'http://130.56.242.15/ows/dea?service=WMS&version=1.3.0&request=GetCapabilities' > capab.txt`;

$input = "capab.txt";
open (INP, "<$input");
@filecontent = <INP>;
close(INP);
my $len = $#filecontent;
#http://130.56.242.15/ows/dea?time=1986-08-15T00%3A00%3A00.000Z&srs=EPSG%3A3857&transparent=true&format=image%2Fpng&exceptions=application%2Fvnd.ogc.se_xml&styles=&tiled=true&feature_count=101&service=WMS&version=1.1.1&request=GetMap&layers=landsat5_nbar_16day&bbox=-20037508.342789244%2C0%2C-10018754.171394622%2C10018754.171394622&width=256&height=256
$ProcessTime = `date`;
chop $ProcessTime;
open (OUT, ">>create_tiles.log");
print "----------$ProcessTime-----------\n";
print OUT "----------$ProcessTime-----------\n";
for (my $j=0; $j <= $len; $j++)
{
	$times = "";
	if($filecontent[$j] =~ /<Layer queryable="1" opaque="0">/)
	{
		$nameLine = $filecontent[++$j];
		if ($nameLine =~ /<Name>(.*)<\/Name>/i)
		{
			$layer = $1;
		}
	}
	if($filecontent[$j] =~ /<Dimension name="time" default="current" current="True" units="ISO8601">(.*)<\/Dimension>/)
	{
		$times = $1;
		@times = split(/,/, $times);
		$ct0 = time();
		foreach $time (@times)
		{
			$date = $time;
			$date =~ s/T.*//g;
			$mkdir = "mkdir -p /local/avs900/Australia/DEA_Tiles/$layer/$date";
#			print "$mkdir\n";
			`$mkdir`;
			$n++;
			for (my $k=0; $k <= $n_tiles; $k++)
			{
				# Skip if the file has already been created
				$png = "/local/avs900/Australia/DEA_Tiles/$layer/$date/$bboxes3857[$k].png";
				$png =~ s/,/_/g;
				print "Checking: $n.$k. $png\n";				
				print OUT "Checking: $n.$k. $png\n";				
				$created = 0;
				if (-f $png) { $created = 1; }
				if ($created)
				{
					print "Skip: $n.$k. $png\n";				
					print OUT "Skip: $n.$k. $png\n";				
				}
				else
				{
					# File is not present. Get it created by GSKY
					$ct1 = time();
					$cmd = "curl 'http://130.56.242.15/ows/dea?time=$time&srs=EPSG:3857&transparent=true&format=image%2Fpng&exceptions=application%2Fvnd.ogc.se_xml&styles=&tiled=true&feature_count=101&service=WMS&version=1.1.1&request=GetMap&layers=$layer&bbox=$bboxes3857[$k]&width=256&height=256'\n";
					print "Creating: $n.$k. $cmd";
					print OUT "Creating: $n.$k. $cmd";
					system($cmd);
					$ct2 = time();
					$et1 = $ct2 - $ct1;
					$et0 += $et1;
					print "Time for this tile: $et1 sec; Total elapsed time: $et0 sec\n";
					$oneTimeSliceCreated++;
					print OUT "Time for this tile: $et1 sec; Total elapsed time: $et0 sec\n";
				}
			}
			last; # Use only the first date
		}
	}
	if ($oneTimeSliceCreated) 
	{ 
		print "Total tiles for $layer $date: $oneTimeSliceCreated\n";
		last; 
	}# Use only the first date
}
close(OUT);
